<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackLogPro - Dropbox Integration Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .section p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.secondary {
            background: #48bb78;
        }
        
        .button.secondary:hover {
            background: #38a169;
        }
        
        .button.danger {
            background: #f56565;
        }
        
        .button.danger:hover {
            background: #e53e3e;
        }
        
        .status {
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .status.info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
        
        .file-list {
            margin-top: 15px;
        }
        
        .file-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }
        
        .file-name {
            font-weight: 500;
            color: #2d3748;
        }
        
        .file-size {
            color: #718096;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        .instructions {
            background: #fff5e1;
            border: 2px solid #ffd700;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .instructions h3 {
            color: #b8860b;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #666;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è TrackLogPro</h1>
            <p>Dropbox Integration Demo for Microsoft Flight Simulator</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>üìã Testing Instructions for Dropbox Reviewers</h3>
                <ol>
                    <li>Click <strong>"Connect to Dropbox"</strong> below to authorize the app</li>
                    <li>Use the <strong>"Upload Sample Files"</strong> buttons to upload test flight data (KML and CSV files)</li>
                    <li>Click <strong>"List My Files"</strong> to see uploaded files in your Dropbox</li>
                    <li>Use <strong>"Download"</strong> buttons to retrieve files from Dropbox</li>
                    <li>All files are stored in <code>/Apps/TrackLogPro/</code> in your Dropbox</li>
                </ol>
            </div>
            
            <!-- Auth Section -->
            <div id="auth-section" class="section">
                <h2>1. Connect to Dropbox</h2>
                <p>First, authorize TrackLogPro to access your Dropbox files.</p>
                <button class="button" onclick="connectDropbox()">Connect to Dropbox</button>
                <div id="auth-status"></div>
            </div>
            
            <!-- Upload Section -->
            <div id="upload-section" class="section hidden">
                <h2>2. Upload Sample Flight Data</h2>
                <p>These buttons upload sample flight tracking files (KML and CSV) to demonstrate the upload functionality used in MSFS.</p>
                <button class="button secondary" onclick="uploadSampleKML()">Upload Sample Flight KML</button>
                <button class="button secondary" onclick="uploadSampleLogbook()">Upload Sample Logbook CSV</button>
                <div id="upload-status"></div>
            </div>
            
            <!-- List Section -->
            <div id="list-section" class="section hidden">
                <h2>3. List & Download Files</h2>
                <p>View files stored in your Dropbox and download them.</p>
                <button class="button" onclick="listFiles()">List My Files</button>
                <div id="file-list" class="file-list"></div>
                <div id="list-status"></div>
            </div>
            
            <!-- Disconnect Section -->
            <div id="disconnect-section" class="section hidden">
                <h2>4. Disconnect</h2>
                <p>Clear authorization and reset the demo.</p>
                <button class="button danger" onclick="disconnect()">Disconnect from Dropbox</button>
            </div>
        </div>
    </div>
    
    <script>
        // Dropbox OAuth Configuration
        const CLIENT_ID = 'uk0pzflsbdzk4wt'; // Replace with your actual App Key
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        
        let accessToken = null;
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Check if we're returning from OAuth
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            if (params.has('access_token')) {
                accessToken = params.get('access_token');
                localStorage.setItem('dropbox_token', accessToken);
                window.location.hash = ''; // Clear hash
                showSuccess('auth-status', '‚úÖ Successfully connected to Dropbox!');
                showConnectedState();
            } else {
                // Check if we have a stored token
                accessToken = localStorage.getItem('dropbox_token');
                if (accessToken) {
                    showConnectedState();
                }
            }
        });
        
        // Connect to Dropbox
        function connectDropbox() {
            const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            window.location.href = authUrl;
        }
        
        // Show connected state
        function showConnectedState() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('list-section').classList.remove('hidden');
            document.getElementById('disconnect-section').classList.remove('hidden');
        }
        
        // Generate sample KML flight data
        function generateSampleKML() {
            const timestamp = new Date().toISOString();
            return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>TrackLogPro Flight - ${timestamp}</name>
        <description>Sample flight from KLAX to KSFO</description>
        <Style id="flightPath">
            <LineStyle>
                <color>ff0000ff</color>
                <width>3</width>
            </LineStyle>
        </Style>
        <Placemark>
            <name>Flight Path</name>
            <description>Los Angeles to San Francisco</description>
            <styleUrl>#flightPath</styleUrl>
            <LineString>
                <altitudeMode>absolute</altitudeMode>
                <coordinates>
                    -118.4085,33.9425,15
                    -118.4100,33.9500,1250
                    -118.4150,34.0000,5280
                    -118.4200,34.1000,10560
                    -118.4300,34.2000,15840
                    -118.4400,34.5000,25000
                    -118.4500,35.0000,32000
                    -118.4600,35.5000,35000
                    -118.4700,36.0000,35000
                    -118.4800,36.5000,32000
                    -118.5000,37.0000,25000
                    -118.5200,37.3000,15000
                    -118.5400,37.5000,8000
                    -118.5600,37.6000,3000
                    -122.3750,37.6189,500
                    -122.3750,37.6189,50
                </coordinates>
            </LineString>
        </Placemark>
        <Placemark>
            <name>Departure: KLAX</name>
            <Point>
                <coordinates>-118.4085,33.9425,0</coordinates>
            </Point>
        </Placemark>
        <Placemark>
            <name>Arrival: KSFO</name>
            <Point>
                <coordinates>-122.3750,37.6189,0</coordinates>
            </Point>
        </Placemark>
    </Document>
</kml>`;
        }
        
        // Generate sample CSV logbook data
        function generateSampleCSV() {
            return `Date,Departure,Arrival,Aircraft,Duration,Distance
${new Date().toLocaleDateString()},KLAX,KSFO,Boeing 737-800,1:45:30,337nm
${new Date(Date.now() - 86400000).toLocaleDateString()},KJFK,KLAX,Airbus A320neo,5:23:15,2475nm
${new Date(Date.now() - 172800000).toLocaleDateString()},EGLL,KJFK,Boeing 787-9,7:42:00,3451nm`;
        }
        
        // Upload sample KML
        async function uploadSampleKML() {
            const kmlContent = generateSampleKML();
            const filename = `flight_${Date.now()}.kml`;
            await uploadFile(filename, kmlContent, 'upload-status');
        }
        
        // Upload sample logbook CSV
        async function uploadSampleLogbook() {
            const csvContent = generateSampleCSV();
            const filename = `logbook_${Date.now()}.csv`;
            await uploadFile(filename, csvContent, 'upload-status');
        }
        
        // Generic file upload function
        async function uploadFile(filename, content, statusElementId) {
            if (!accessToken) {
                showError(statusElementId, 'Please connect to Dropbox first');
                return;
            }
            
            showInfo(statusElementId, `Uploading ${filename}...`);
            
            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Dropbox-API-Arg': JSON.stringify({
                            path: `/TrackLogPro/${filename}`,
                            mode: 'add',
                            autorename: true,
                            mute: false
                        }),
                        'Content-Type': 'application/octet-stream'
                    },
                    body: content
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                showSuccess(statusElementId, `‚úÖ Successfully uploaded: ${result.name}`);
            } catch (error) {
                showError(statusElementId, `‚ùå Upload failed: ${error.message}`);
            }
        }
        
        // List files from Dropbox
        async function listFiles() {
            if (!accessToken) {
                showError('list-status', 'Please connect to Dropbox first');
                return;
            }
            
            showInfo('list-status', 'Loading files...');
            
            try {
                const response = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: '/TrackLogPro',
                        recursive: false,
                        include_deleted: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to list files: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayFiles(result.entries);
                showSuccess('list-status', `‚úÖ Found ${result.entries.length} file(s)`);
            } catch (error) {
                showError('list-status', `‚ùå Failed to list files: ${error.message}`);
            }
        }
        
        // Display files
        function displayFiles(entries) {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            
            if (entries.length === 0) {
                fileList.innerHTML = '<p style="color: #666;">No files found. Upload some files first!</p>';
                return;
            }
            
            entries.forEach(entry => {
                if (entry['.tag'] === 'file') {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div>
                            <div class="file-name">${entry.name}</div>
                            <div class="file-size">${formatBytes(entry.size)}</div>
                        </div>
                        <button class="button" onclick="downloadFile('${entry.path_display}', '${entry.name}')">Download</button>
                    `;
                    fileList.appendChild(fileItem);
                }
            });
        }
        
        // Download file
        async function downloadFile(path, filename) {
            if (!accessToken) {
                showError('list-status', 'Please connect to Dropbox first');
                return;
            }
            
            showInfo('list-status', `Downloading ${filename}...`);
            
            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Dropbox-API-Arg': JSON.stringify({ path: path })
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Download failed: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('list-status', `‚úÖ Downloaded: ${filename}`);
            } catch (error) {
                showError('list-status', `‚ùå Download failed: ${error.message}`);
            }
        }
        
        // Disconnect
        function disconnect() {
            localStorage.removeItem('dropbox_token');
            accessToken = null;
            window.location.reload();
        }
        
        // Helper functions for status messages
        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status success">${message}</div>`;
        }
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status error">${message}</div>`;
        }
        
        function showInfo(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status info">${message}</div>`;
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
